<!DOCTYPE html>
<html xmlns:v="urn:schemas-microsoft-com:vml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>流程图DEMO</title>
    <!--[if lt IE 9]>
    <?import namespace="v" implementation="#default#VML" ?>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="../codebase/GooFlow.css" />
    <style>
        .myForm {
            display: block;
            margin: 0px;
            padding: 0px;
            line-height: 1.5;
            border: #ccc 1px solid;
            font: 12px Arial, Helvetica, sans-serif;
            margin: 5px 5px 0px 0px;
            border-radius: 4px;
        }

            .myForm .form_title {
                background: #428bca;
                padding: 4px;
                color: #fff;
                border-radius: 3px 3px 0px 0px;
            }

            .myForm .form_content {
                padding: 4px;
                background: #fff;
            }

                .myForm .form_content table {
                    border: 0px;
                }

                    .myForm .form_content table td {
                        border: 0px;
                    }

                    .myForm .form_content table .th {
                        text-align: right;
                        font-weight: bold;
                    }

            .myForm .form_btn_div {
                text-align: center;
                border-top: #ccc 1px solid;
                background: #f5f5f5;
                padding: 4px;
                border-radius: 0px 0px 3px 3px;
            }

        #propertyForm {
            float: left;
        }
    </style>
    <script type="text/javascript" src="child.js"></script>
    <script type="text/javascript" src="../plugin/jquery.min.js"></script>
    <script type="text/javascript" src="../codebase/GooFunc.js"></script>
    <script type="text/javascript" src="../plugin/json2.js"></script>
    <link rel="stylesheet" type="text/css" href="default.css" />
    <script type="text/javascript" src="../codebase/GooFlow.js"></script>
    <script type="text/javascript" src="../codebase/GooFlow.color.js"></script>
    <script type="text/javascript" src="../plugin/promise.min.js"></script>
    <script type="text/javascript" src="../plugin/html2canvas.js"></script>
    <script src="../../../Scripts/layer/2.4/layer.js"></script>
    <!--[if lte IE 11]>
    <script type="text/javascript" src="../plugin/canvg.js"></script>
    <![endif]-->
    
    <script type="text/javascript">
        var property = {
            width: 1250,
            height: 600,
            toolBtns: ["start round mix", "end round", "task", "node", "chat", "state", "plug", "join", "fork", "complex mix"],
            haveHead: true,
            headLabel: true,
            headBtns: ["undo", "redo", "reload", "print"],//如果haveHead=true，则定义HEAD区的按钮
            haveTool: true,
            haveDashed: true,
            haveGroup: true,
            useOperStack: true
        };
        var remark = {
            cursor: "选择指针",
            direct: "结点连线",
            start: "入口结点",
            "end": "结束结点",
            "task": "任务结点",
            node: "自动结点",
            chat: "决策结点",
            state: "状态结点",
            plug: "附加插件",
            fork: "分支结点",
            "join": "联合结点",
            "complex mix": "复合结点",
            group: "组织划分框编辑开关"
        };
        var demo;
        $(document).ready(function () {
            //导出图片功能 END
            var exportName = "TestFlow";
            demo = $.createGooFlow($("#demo"), property);
            demo.setNodeRemarks(remark);
            demo.onItemDel = function (id, type) {
                //删除弹框
                this.blurItem();
                return true;
                //		if(confirm("确定要删除该单元吗?")){
                //
                //		}else{
                //      return false;
                //		}
            }
            demo.onPrintClick = function () {
               
                demo.exportDiagram(exportName);
            }
        
            //demo.loadData(jsondata);

            //demo.onItemFocus=function(id,model){
            //  var obj;
            //  $("#ele_model").val(model);
            //  $("#ele_id").val(id);
            //  if(model=="line"){
            //    obj=this.$lineData[id];
            //    $("#ele_type").val(obj.M);
            //    $("#ele_left").val("");
            //    $("#ele_top").val("");
            //    $("#ele_width").val("");
            //    $("#ele_height").val("");
            //    $("#ele_from").val(obj.from);
            //    $("#ele_to").val(obj.to);
            //  }else if(model=="node"){
            //    obj=this.$nodeData[id];
            //    $("#ele_left").val(obj.left);
            //      $("#ele_type").val(obj.type);
            //    $("#ele_top").val(obj.top);
            //    $("#ele_width").val(obj.width);
            //    $("#ele_height").val(obj.height);
            //    $("#ele_from").val("");
            //    $("#ele_to").val("");
            //  }
            //  $("#ele_name").val(obj.name);
            //    $("#ele_sort").val(obj.sort);
            //  return true;
            //};
            //demo.onItemBlur=function(id,model){
            //document.getElementById("propertyForm").reset();
            //return true;
            //};
            //demo.resetScale( parseFloat(1.2) );
        });
        var out;
        function Export() {
            document.getElementById("result").value = JSON.stringify(demo.exportData());
        }

        //带id
        function Export2() {
            document.getElementById("result2").value = JSON.stringify(demo.exportData2());
        }
        //回绑确定按钮
        function Submit(name) {
            demo.setName(demo.$focus, name, "node");
            demo.setName(demo.$focus, name, "line");
            //alert( JSON.stringify(demo.$nodeData));
            //alert( JSON.stringify(demo.getItemInfo(demo.$focus,"node").exportData()) );
        }
        function InputData() {
           
            demo.clearData();
            demo.loadData(JSON.parse(document.getElementById("inputresult").value));
        }
        function LoadSource(SourceData) {
            demo.loadData(JSON.parse(SourceData));
        }

        function Select(id, oldID) {
            demo.markItem(oldID, "node", false)
            //demo.focusItem(id,true);
            demo.markItem(id, "node", true)

        }
        //清空数据
        function clear() {
            demo.clearData();
        }
        //保存json对象

    </script>
</head>
<body>
    <div id="demo" style="margin:5px;float:left"></div>
    <!--<form class="myForm" id="propertyForm">
    <div class="form_title">属性设置</div>
    <div class="form_content">
      <table>
          <tr><td class="th">Id：</td><td><input type="text" style="width:200px;" id="ele_id"/></td></tr>
          <tr><td class="th">Name：</td><td><input type="text" style="width:200px;" id="ele_name"/></td></tr>
          <tr><td class="th">Type：</td><td><input type="text" style="width:200px;" id="ele_type"/></td></tr>
          <tr><td class="th">Model：</td><td><input type="text" style="width:200px;" id="ele_model"/></td></tr>
          <tr><td class="th">Left-r：</td><td><input type="text" style="width:200px;" id="ele_left"/></td></tr>
          <tr><td class="th">Top-r：</td><td><input type="text" style="width:200px;" id="ele_top"/></td></tr>
          <tr><td class="th">Width：</td><td><input type="text" style="width:200px;" id="ele_width"/></td></tr>
          <tr><td class="th">Height：</td><td><input type="text" style="width:200px;" id="ele_height"/></td></tr>
          <tr><td class="th">From：</td><td><input type="text" style="width:200px;" id="ele_from"/></td></tr>
          <tr><td class="th">To：</td><td><input type="text" style="width:200px;" id="ele_to"/></td></tr>
          <tr><td class="th">Sort：</td><td><input type="text" style="width:200px;" id="ele_sort"/></td></tr>
      </table>
    </div>
    <div class="form_btn_div">
      <input type="reset" value="重置"/>
        <input type="button" value="确定" onclick="Submit($('#ele_name').val());" />
    </div>
    </form>-->
    <div style="clear:both;">
        <input id="submit" type="button" value='导出结果' onclick="Export()"  style="display:none;"/>
        <input id="clear" type="button" value='清空' onclick="clear()" style="display:none;" />
        <input type="button" value='导入结果' id="export_rode" onclick="InputData();" style="display:none;" />
        <a id="Save_Json" href="#" onclick="$('.GooFlow_head_btn').click();" style="display:inline-block;border-radius:4px;margin-left:20px;outline:none;width:100px;height:30px;line-height:30px;text-align:center;background:#428bca;color:#fff;text-decoration:none">Save</a>
        <!--获取父页面的选中行的MTR单号-->
      
        <textarea id="result" row="6" cols="10" style="width:98%;height:80px;margin:10px auto;display:none;"></textarea>
        <textarea id="result2" row="6" cols="10" style="width:98%;height:80px;margin:10px auto;display:none;"></textarea>
        <div style="height:15px;display:none;">导入结果：</div>
        <textarea id="inputresult" row="6" cols="10" style="width:98%;height:80px;margin:10px auto;display:none;"></textarea>
    </div>
</body>
</html>
<script type="text/javascript">
    /*
 * 专门负责导出流程图文件并让用户下载的扩展包方法，需要依赖:
 * ../plugin/promise.min.js
 * ../plugin/html2canvas.min.js
 * ../plugin/canvg.js (当必须在IE11及以下版本的IE浏览器上运行时)
 */
    GooFlow.prototype.exportDiagram = function (fileName) {

        //0.添加临时元素
        var width = this.$workArea.width();
        var height = this.$workArea.height();
        $("body").append('<div id="demo_export" style="position:absolute;top:0;left:0;z-index:-1;width:0px;height:0px;overflow:hidden">'
            + '<div style="color:#15428B;position:absolute;left:0;right:0;width:' + width + 'px;height:' + height + 'px;overflow:hidden;float:none;" class="GooFlow GooFlow_work"></div>'
            + '</div>');

        //1.先COPY节点和区块的内容
        var inner = $("#demo").find(".GooFlow_work_inner");
        var divCanvas = $("#demo_export").children("div:eq(0)");

        //复制节点的内容
        inner.children("div").each(function (i) {
            var item = $(this);
            if (item.hasClass("GooFlow_item")) {
                item.clone().removeAttr("id").css("position", "absolute").appendTo(divCanvas);
            } else if (item.hasClass("GooFlow_work_group")) {
                item.clone().removeAttr("id").css("position", "absolute")
                    .attr("xmlns", 'http://www.w3.org/1999/xhtml').appendTo(divCanvas);
            }
        });

        html2canvas(divCanvas[0], {
            allowTaint: false, taintTest: false,
            onrendered: function (canvas) {
                //2.在回调方法中，COPY连线内容
                //造出临时的IMAGE
                var context = canvas.getContext('2d');//取得画布的2d绘图上下文
                context.save();
                var strSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="' + width + '" height="' + height + '">'
                    + '<defs><style type="text/css">text{font-size:14px;line-height:1.42857143;'
                    + 'font-family:"Microsoft Yahei", "Helvetica Neue", Helvetica, Hiragino Sans GB, WenQuanYi Micro Hei, Arial, sans-serif;'
                    + '}</style></defs>' + window.$("<svg>").append(window.$("#draw_demo").clone()).html() + '</svg>'; //COPY连线内容
                var image = null;
                debugger;
                if (!!window.ActiveXObject || "ActiveXObject" in window) {//当为IE11及以下版本浏览器时，使用Canvg第三方工具

                    image = document.createElement('canvas');

                    //  strSvg = encodeURIComponent(strSvg);


                    canvg(image, strSvg);

                } else {
                    var image = new Image();
                    image.src = 'data:image/svg+xml,' + encodeURIComponent(strSvg);
                }
                var tempFunc = function () {
                    alert(2);
                    context.drawImage(image, 0, 0);
                    //清除不需要的临时DOM
                    $("#demo_export").empty().remove();
                    try {
                        var blob = canvas.msToBlob();
                        //alert("blob2");
                        navigator.msSaveBlob(blob, "prettyImage.png");
                    }
                    catch (e) {
                        //生成一个下载链接并点击
                        var a = document.createElementNS("http://www.w3.org/1999/xhtml", "a")
                        a.href = canvas.toDataURL('image/png');  //将画布内的信息导出为png图片数据
                        a.download = fileName + ".png";  //设定下载名称
                        document.getElementById("result").value = JSON.stringify(demo.exportData());
                        document.getElementById("result2").value = JSON.stringify(demo.exportData2());
                        var MTRNO = document.getElementById("MTRNO").value;//MTR单号
                        $.ajax({
                            url: "/ScheduleManagement/SaveMTRProcessDesignIMG",//接收一般处理程序返回来的json数据
                            data: {
                                MTRNO: MTRNO,
                                IMGbase64: a.href,
                                nodeinfo: document.getElementById("result").value,
                                nodeinfoID: document.getElementById("result2").value
                            },
                            type: "POST",
                            success: function (data) {
                                var result = $.parseJSON(data);
                                if (result.Success == true) {
                                    layer.alert(result.Message);
                                    //  $.messager.alert('提示', result.Message);
                                    $('#MTR_information_datagrid').datagrid('reload');
                                } else {
                                    layer.alert(result.Message);
                                    //  $.messager.alert('提示', result.Message);

                                }
                            }
                        });
                        //   console.log( fileName + ".png")
                        document.body.appendChild(a);
                        a.click(); //点击触发下载

                        document.body.removeChild(a);
                    }
                }

                if (image.complete || (!!window.ActiveXObject || "ActiveXObject" in window)) { // 如果图片已经存在于浏览器缓存，直接调用回调函数
                    console.log("image.complete|| IE11");
                    tempFunc();
                    return;// 直接返回，不用再处理onload事件
                }
                image.onload = function () {
                    //console.log("image.onload");
                    tempFunc();
                };
            },
            width: width,
            height: height
        });
    }
    /*
     *  打印预览或另存为PDF功能，需要依赖:
     * ../plugin/printThis.js
     */
    GooFlow.prototype.print = function (scale) {
        var max = this.suitSize();
        if (!scale) scale = 1.0;
        max.width += 20; max.height += 20;
        var printDiv = this.$workArea.clone();
        printDiv.css({
            width: max.width + "px", height: max.height + "px"
        });
        printDiv.children(".GooFlow_work_group").css({ width: max.width + "px", height: max.height + "px" });
        printDiv.children("svg").css({ width: max.width + "px", height: max.height + "px" });
        printDiv.children(".GooFlow_work_vml").css({ width: max.width + "px", height: max.height + "px" });
        printDiv = printDiv.wrap("<div class='GooFlow GooFlow_work'></div>").parent();
        if (GooFlow.prototype.color.font) {
            printDiv.css("color", GooFlow.prototype.color.font);
        }
        printDiv.css({ "transform-origin": "top right", transform: "scale(" + scale + ")" }).printThis({ debug: true, base: document.URL });
    }
</script>